# CLAUDE.md Schema Rules - Single Source of Truth
# This file defines all validation rules for CLAUDE.md files.
# Rules are consumed by:
#   - Rust core engine (build-time code generation via build.rs)
#   - Documentation (templates/claude-md-schema.md)
#   - Schema-validate skill (skills/schema-validate/SKILL.md)

version: "2.0.0"
description: "CLAUDE.md 스키마 검증 규칙 - Single Source of Truth (v2: Symbol Index + Diagrams)"

sections:
  purpose:
    name: "Purpose"
    required: true
    condition: "always"
    allow_none: false
    description: "디렉토리의 책임을 1-2문장으로 명시"

  summary:
    name: "Summary"
    required: true
    condition: "always"
    allow_none: false
    description: "모듈의 역할/책임/주요 기능을 1-2문장으로 요약"

  exports:
    name: "Exports"
    required: true
    condition: "always"
    allow_none: true
    description: "모듈의 public interface를 시그니처 레벨로, 각 심볼은 cross-reference 앵커"
    validation:
      pattern: "^[A-Za-z_][A-Za-z0-9_]*\\s*\\([^)]*\\).*"
      description: "함수 시그니처 형식: Name(params): ReturnType"
    indexable: true
    anchor_source: "name"
    v2_format:
      heading_required: true
      heading_pattern: "^####\\s+([A-Za-z_][A-Za-z0-9_]*)"
      description_follows_signature: true

  behavior:
    name: "Behavior"
    required: true
    condition: "always"
    allow_none: true
    description: "동작을 시나리오 레벨 (input → output)로 명시, UseCase 다이어그램 생성 가능"
    validation:
      pattern: ".+\\s*[→->].+"
      description: "시나리오 형식: input → output"
    subsections:
      - actors
      - use_cases
    usecase_metadata:
      actor_pattern: "^-\\s+(.+?):\\s+(.+)"
      id_pattern: "^###\\s+UC-(\\d+):\\s+(.+)"
      include_pattern: "^-\\s+Includes?:\\s+(.+)"
      extend_pattern: "^-\\s+Extends?:\\s+(.+)"
      actor_ref_pattern: "^-\\s+Actor:\\s+(.+)"

  contract:
    name: "Contract"
    required: true
    condition: "always"
    allow_none: true
    description: "함수별 사전조건, 사후조건, 불변식"
    subsections:
      - preconditions
      - postconditions
      - throws
      - invariants

  protocol:
    name: "Protocol"
    required: true
    condition: "always"
    allow_none: true
    description: "상태 전이나 호출 순서"
    subsections:
      - state_machine
      - lifecycle

  domain_context:
    name: "Domain Context"
    required: true
    condition: "always"
    allow_none: true
    description: "compile 시 동일한 코드 재현을 보장하기 위한 맥락 (결정 근거, 제약 조건, 호환성 요구)"
    subsections:
      - decision_rationale
      - constraints
      - compatibility

  structure:
    name: "Structure"
    required: false
    condition: "has_subdirs_or_files"
    allow_none: false
    description: "하위 디렉토리나 파일이 있는 경우 구조 설명"

  dependencies:
    name: "Dependencies"
    required: false
    condition: "has_external_or_internal_deps"
    allow_none: false
    description: "외부/내부 의존성 목록"

  constraints:
    name: "Constraints"
    required: false
    condition: "has_constraints"
    allow_none: false
    description: "지켜야 할 규칙이나 제약사항"

reference_rules:
  forbidden_patterns:
    - pattern: "\\.\\./"
      description: "부모 디렉토리 참조 금지"
    - pattern: "\\.\\.\\\\/"
      description: "부모 디렉토리 참조 금지 (Windows)"

  allowed_patterns:
    - pattern: "^\\.\\/|^\\.\\\\/"
      description: "자식 디렉토리 참조 허용"

none_marker:
  values:
    - "None"
    - "none"
    - "N/A"
    - "n/a"
  description: "명시적으로 해당 섹션이 비어있음을 표시하는 값"

cross_reference:
  format: "{path}/CLAUDE.md#{symbolName}"
  anchor_source: "export_name"

schema_version:
  marker_pattern: "^<!--\\s*schema:\\s*(\\d+\\.\\d+)\\s*-->"
  current: "2.0"
  supported:
    - "1.0"
    - "2.0"
