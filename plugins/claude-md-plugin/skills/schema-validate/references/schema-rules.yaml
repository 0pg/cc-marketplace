# CLAUDE.md Schema Rules - Single Source of Truth
# This file defines all validation rules for CLAUDE.md files.
# Rules are consumed by:
#   - Rust core engine (build-time code generation via build.rs)
#   - Documentation (templates/claude-md-schema.md)
#   - Schema-validate skill (skills/schema-validate/SKILL.md)

version: "2.0.0"
description: "CLAUDE.md 스키마 검증 규칙 - Single Source of Truth (v2: Symbol Index + Diagrams)"

sections:
  purpose:
    name: "Purpose"
    required: true
    condition: "always"
    allow_none: false
    description: "디렉토리의 책임을 1-2문장으로 명시"

  summary:
    name: "Summary"
    required: true
    condition: "always"
    allow_none: false
    description: "모듈의 역할/책임/주요 기능을 1-2문장으로 요약"

  exports:
    name: "Exports"
    required: true
    condition: "always"
    allow_none: true
    description: "모듈의 public interface를 시그니처 레벨로, 각 심볼은 cross-reference 앵커"
    validation:
      pattern: "^[A-Za-z_][A-Za-z0-9_]*\\s*\\([^)]*\\).*"
      description: "함수 시그니처 형식: Name(params): ReturnType"
    indexable: true
    anchor_source: "name"
    v2_format:
      heading_required: true
      heading_pattern: "^####\\s+([A-Za-z_][A-Za-z0-9_]*)"
      description_follows_signature: true

  behavior:
    name: "Behavior"
    required: true
    condition: "always"
    allow_none: true
    description: "동작을 시나리오 레벨 (input → output)로 명시, UseCase 다이어그램 생성 가능"
    validation:
      pattern: ".+\\s*[→->].+"
      description: "시나리오 형식: input → output"
    subsections:
      - actors
      - use_cases
    usecase_metadata:
      actor_pattern: "^-\\s+(.+?):\\s+(.+)"
      id_pattern: "^###\\s+UC-(\\d+):\\s+(.+)"
      include_pattern: "^-\\s+Includes?:\\s+(.+)"
      extend_pattern: "^-\\s+Extends?:\\s+(.+)"
      actor_ref_pattern: "^-\\s+Actor:\\s+(.+)"

  contract:
    name: "Contract"
    required: true
    condition: "always"
    allow_none: true
    description: "함수별 사전조건, 사후조건, 불변식"
    subsections:
      - preconditions
      - postconditions
      - throws
      - invariants

  protocol:
    name: "Protocol"
    required: true
    condition: "always"
    allow_none: true
    description: "상태 전이나 호출 순서"
    subsections:
      - state_machine
      - lifecycle

  domain_context:
    name: "Domain Context"
    required: true
    condition: "always"
    allow_none: true
    description: "compile 시 동일한 코드 재현을 보장하기 위한 맥락 (결정 근거, 제약 조건, 호환성 요구)"
    subsections:
      - decision_rationale
      - constraints
      - compatibility

  structure:
    name: "Structure"
    required: false
    condition: "has_subdirs_or_files"
    allow_none: false
    description: "하위 디렉토리나 파일이 있는 경우 구조 설명"

  dependencies:
    name: "Dependencies"
    required: false
    condition: "has_external_or_internal_deps"
    allow_none: false
    description: "외부/내부 의존성 목록"

  constraints:
    name: "Constraints"
    required: false
    condition: "has_constraints"
    allow_none: false
    description: "지켜야 할 규칙이나 제약사항"

# ─────────────────────────────────────────────────────────
# IMPLEMENTS.md Schema Rules
# ─────────────────────────────────────────────────────────

implements_sections:
  architecture_decisions:
    name: "Architecture Decisions"
    required: true
    condition: "always"
    allow_none: true
    description: "아키텍처 설계 결정과 근거"

  module_integration_map:
    name: "Module Integration Map"
    required: false
    condition: "has_internal_deps"
    allow_none: true
    description: "내부 모듈 의존성의 Export 레벨 통합 명세"
    entry_schema:
      header:
        pattern: "^###\\s+`[^`]+`\\s*→\\s*.+/CLAUDE\\.md$"
        description: "### `{relative_path}` → {module_name}/CLAUDE.md"
        captures:
          - name: "relative_path"
            group: 1
            description: "현재 모듈 기준 상대 경로"
          - name: "claude_md_ref"
            group: 2
            description: "대상 CLAUDE.md 식별자"
      required_subsections:
        exports_used:
          header: "#### Exports Used"
          required: true
          item_pattern: "^[-*]\\s+`([^`]+)`(?:\\s*—\\s*(.+))?$"
          item_captures:
            - name: "signature"
              group: 1
              description: "Export 시그니처 (CLAUDE.md Exports 형식 준수)"
            - name: "role_description"
              group: 2
              description: "역할 설명 (선택)"
          min_items: 1
          signature_validation: "same_as_exports"
        integration_context:
          header: "#### Integration Context"
          required: true
          allow_empty: false
          description: "사용 목적과 통합 방식 (1-3문장)"
    cross_validation:
      - rule: "export_exists"
        description: "참조한 Export가 대상 CLAUDE.md Exports에 존재하는지 검증"
        severity: "error"
      - rule: "signature_match"
        description: "스냅샷 시그니처와 대상 CLAUDE.md 시그니처 일치 검증"
        severity: "warning"
      - rule: "boundary_valid"
        description: "상대 경로가 유효한 모듈을 가리키는지 검증"
        severity: "error"

  external_dependencies:
    name: "External Dependencies"
    required: true
    condition: "always"
    allow_none: true
    description: "외부 패키지 의존성과 선택 근거"

  implementation_approach:
    name: "Implementation Approach"
    required: true
    condition: "always"
    allow_none: false
    description: "구현 방향과 전략"

  technology_choices:
    name: "Technology Choices"
    required: true
    condition: "always"
    allow_none: true
    description: "기술 선택과 근거"

  algorithm:
    name: "Algorithm"
    required: false
    condition: "has_complex_logic"
    description: "복잡하거나 비직관적인 구현 로직"

  key_constants:
    name: "Key Constants"
    required: false
    condition: "has_domain_constants"
    description: "도메인 의미 있는 상수"

  error_handling:
    name: "Error Handling"
    required: true
    condition: "always"
    allow_none: true
    description: "에러 처리 전략"

  state_management:
    name: "State Management"
    required: true
    condition: "always"
    allow_none: true
    description: "상태 관리 방식"

  implementation_guide:
    name: "Implementation Guide"
    required: false
    condition: "has_additional_notes"
    description: "compile 시 발견된 추가 참고 정보"

reference_rules:
  forbidden_patterns:
    - pattern: "\\.\\./"
      description: "부모 디렉토리 참조 금지"
    - pattern: "\\.\\.\\\\/"
      description: "부모 디렉토리 참조 금지 (Windows)"

  allowed_patterns:
    - pattern: "^\\.\\/|^\\.\\\\/"
      description: "자식 디렉토리 참조 허용"

none_marker:
  values:
    - "None"
    - "none"
    - "N/A"
    - "n/a"
  description: "명시적으로 해당 섹션이 비어있음을 표시하는 값"

cross_reference:
  format: "{path}/CLAUDE.md#{symbolName}"
  anchor_source: "export_name"

schema_version:
  marker_pattern: "^<!--\\s*schema:\\s*(\\d+\\.\\d+)\\s*-->"
  current: "2.0"
  supported:
    - "1.0"
    - "2.0"
